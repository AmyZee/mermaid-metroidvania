<!DOCTYPE html>
<html>
<head>
<title>Mermaid Metroidvania</title>
<meta charset="utf-8">
<style>
	body{
		margin: 0;
	}
	#game{
		width: 100%;
		height: 160vw;
		border: 1px solid black;
    		display: none;
		box-sizing: border-box;
	}
	#info{
		width: 100%;
	}
</style>
</head>
<body>
<button id="activate-acceleration" onclick="start()" style="height:176px; font-size: 80px;">Activate Acceleration</button>
<div id="info"></div>
<canvas width="1000" height="1600" id="game"></canvas>

<script>
var setDeviceStartingOrientation = 0
var player = {}
	player.movement = {}
	player.movement.positionX = 500
	player.movement.positionY = 500
	player.movement.newPositionX = 500
	player.movement.newPositionY = 500
	player.movement.startingPhoneRotationX = 0
	player.movement.startingPhoneRotationY = 0
	player.movement.maxSpeed = 0.1
	player.movement.maxTiltX = 0
	player.movement.innerZoneRadius = 80 //Slow down at this point
	player.movement.outerZoneRadius = 100 //Full stop at this point

var block = {}
	block.empty = {}
	block.empty.img = "img/block-empty.png"
	block.solid = {}
	block.solid.img = "☐"
	block.solid.physics = function(){
		if (player.movement.newPositionX < player.movement.positionX){
			//...
		}
		//Stop movement, must be done for relevant positionX and positionY when using slopes using if-statements like above, here it can be done universally.
		player.movement.newPositionX = player.movement.positionX
		player.movement.newPositionY = player.movement.positionY
		
	}
	block.slopeBottomLeftNormal = {}


var level = {}
	level.testLevel = {}
		level.testLevel.grid = [
			//" " or "0" = empty block, "☐" = solid block
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐", "☐",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],

			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],

			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			["0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",   "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",      "0", "0", "0", "0", "0", "0", "0", "0", "0", "0",],
			
		]
	
var playersprite = new Image()
	playersprite.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Godot_icon.svg/480px-Godot_icon.svg.png"

var context = document.getElementById("game").getContext("2d")

	
function start(){

	setDeviceStartingOrientation = 0
	
	DeviceMotionEvent.requestPermission().then(function(response){
		if (response == "granted"){
			document.getElementById("game").style.display = "block"
			document.getElementById("activate-acceleration").innerHTML = "Reset accelerometer"
			window.addEventListener("deviceorientation", function(e){
				player.movement.newPositionX = player.movement.positionX + e.gamma * player.movement.maxSpeed
				player.movement.newPositionY = player.movement.positionY + e.beta * player.movement.maxSpeed
				if (setDeviceStartingOrientation == 1){
					return
				} else {
					player.movement.statingPhoneRotationX = e.gamma
					player.movement.statingPhoneRotationY = e.beta
					setDeviceStartingOrientation = 1
				}
			})
		}
	})
	
	document.getElementById("game").getContext("2d").drawImage(playersprite, player.positionX - 50, player.positionY - 50, 100, 100)
	
	gameLoop()

}

function gameLoop(){

	drawMovementZone()

	playerMovement()

	window.requestAnimationFrame(gameLoop)
	
}


function drawMovementZone(){
	
	document.getElementById("game").getContext("2d").clearRect(0, 0, 1000, 1600)


	//Display Grid 50 by 50 units, 25 by 25 sub-units

	document.getElementById("game").getContext("2d").strokeStyle = "#aaa"
	for (i = 25; i < 1000; i+=50){
		for (j = 25; j < 1600; j+=50){
			document.getElementById("game").getContext("2d").beginPath()
			document.getElementById("game").getContext("2d").moveTo(i, 0)
			document.getElementById("game").getContext("2d").lineTo(i, 1600)
			document.getElementById("game").getContext("2d").stroke()

			document.getElementById("game").getContext("2d").beginPath()
			document.getElementById("game").getContext("2d").moveTo(0, j)
			document.getElementById("game").getContext("2d").lineTo(1000, j)
			document.getElementById("game").getContext("2d").stroke()
		}
		
	}
	


	document.getElementById("game").getContext("2d").strokeStyle = "#555"
	for (i = 50; i < 1000; i+=100){
		for (j = 50; j < 1600; j+=100){
			document.getElementById("game").getContext("2d").beginPath()
			document.getElementById("game").getContext("2d").moveTo(i, 0)
			document.getElementById("game").getContext("2d").lineTo(i, 1600)
			document.getElementById("game").getContext("2d").stroke()

			document.getElementById("game").getContext("2d").beginPath()
			document.getElementById("game").getContext("2d").moveTo(0, j)
			document.getElementById("game").getContext("2d").lineTo(1000, j)
			document.getElementById("game").getContext("2d").stroke()
		}
		
	}

	document.getElementById("game").getContext("2d").strokeStyle = "#000"
	for (i = 100; i < 1000; i+=100){
		for (j = 100; j < 1600; j+=100){
			document.getElementById("game").getContext("2d").beginPath()
			document.getElementById("game").getContext("2d").moveTo(i, 0)
			document.getElementById("game").getContext("2d").lineTo(i, 1600)
			document.getElementById("game").getContext("2d").stroke()

			document.getElementById("game").getContext("2d").beginPath()
			document.getElementById("game").getContext("2d").moveTo(0, j)
			document.getElementById("game").getContext("2d").lineTo(1000, j)
			document.getElementById("game").getContext("2d").stroke()
		}
		
	}

	//Draw player
	document.getElementById("game").getContext("2d").beginPath()
	document.getElementById("game").getContext("2d").arc(500, 500, player.movement.outerZoneRadius, 0, 2 * Math.PI)
	document.getElementById("game").getContext("2d").stroke()
	document.getElementById("game").getContext("2d").drawImage(playersprite, player.movement.positionX - 50, player.movement.positionY - 50, 100, 100)
	
	
}
	
function playerMovement(){

	limitMovement()

	player.movement.positionX = player.movement.newPositionX - player.movement.statingPhoneRotationX
	player.movement.positionY = player.movement.newPositionY - player.movement.statingPhoneRotationY
	
	document.getElementById("info").innerHTML = `positionX = ${player.movement.positionX} | positionY = ${player.movement.positionY}`
}
	
function limitMovement(){

	function limitToTriangularCircle(){
		//Radius c^2 = x^2 + y^2 (Pythagoras theorem)
		//If (c^2 > (x^2 + y^2)) { current position is outside circle } //if c^2 <, current position is inside circle
			//Then draw line to center (0,0), calculating c^2 diagonal line by doing x^2 + y^2
			//Compare to same point on circle, where c^2 == x^2 + y^2
			//Use that position instead for movement calculation (i.e. teleport to that position every frame)
			//That way, positioning outside circle is still calculated correctly when changing radius

		var isPlayerOutsideCircle = ((player.movement.newPositionX - 500) ** 2) + ((player.movement.newPositionY - 500) ** 2)
		if (isPlayerOutsideCircle > (player.movement.outerZoneRadius ** 2)){
			//Player is outside circle
			player.movement.newPositionX = player.movement.positionX
			player.movement.newPositionY = player.movement.positionY			
			document.getElementById("info").style.color = "red"
			//(player.movement.newPositionX ** 2) + (player.movement.newPositionY ** 2)
		} else if (isPlayerOutsideCircle > (player.movement.innerZoneRadius ** 2) && (((player.movement.positionX - 500) ** 2) + ((player.movement.positionY - 500) ** 2)) < isPlayerOutsideCircle) { //radius 80 * 80, slow down outside!
			player.movement.maxSpeed = ((player.movement.outerZoneRadius ** 2) - isPlayerOutsideCircle) * 0.001
			document.getElementById("info").style.color = "yellow"
		} else {
			player.movement.maxSpeed = 0.1
			document.getElementById("info").style.color = "black"
		}
	}

	limitToTriangularCircle()
	
	function limitToLevelObjects(){
		

	}
	limitToLevelObjects()
	
	

}



	
</script>
</body>
</html>
